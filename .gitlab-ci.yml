# GitLab CI/CD Configuration for wanLLMDB
# Automated testing, security validation, and Docker image building

# ============================================================================
# Global Configuration
# ============================================================================

image: python:3.11-slim

variables:
  PYTHON_VERSION: "3.11"
  POETRY_VERSION: "1.5.1"
  POETRY_HOME: "/opt/poetry"
  POETRY_NO_INTERACTION: "1"
  POETRY_VIRTUALENVS_CREATE: "false"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  POSTGRES_DB: wanllmdb_test
  POSTGRES_USER: wanllm
  POSTGRES_PASSWORD: test_password_for_ci_min_12_chars
  REDIS_URL: redis://redis:6379/0
  DATABASE_URL: postgresql://wanllm:test_password_for_ci_min_12_chars@postgres:5432/wanllmdb_test
  SECRET_KEY: test_secret_key_for_ci_min_32_characters_long_string_here
  MINIO_ACCESS_KEY: test_minio_access_key_12_chars
  MINIO_SECRET_KEY: test_minio_secret_key_12_chars
  MINIO_ENDPOINT: minio:9000
  MINIO_SECURE: "false"
  MINIO_BUCKET_NAME: test-bucket

# Pipeline stages
stages:
  - setup
  - lint
  - test
  - security
  - build
  - deploy

# Cache configuration
cache:
  paths:
    - .cache/pip
    - backend/.venv/

# ============================================================================
# STAGE: Setup
# ============================================================================

install-dependencies:
  stage: setup
  script:
    - apt-get update && apt-get install -y curl gcc postgresql-client libpq-dev
    - curl -sSL https://install.python-poetry.org | python3 -
    - export PATH="/root/.local/bin:$PATH"
    - cd backend
    - poetry install --no-root --no-interaction
  cache:
    key: ${CI_COMMIT_REF_SLUG}-poetry
    paths:
      - backend/.venv/
      - /root/.cache/pypoetry
  artifacts:
    paths:
      - backend/.venv/
    expire_in: 1 hour

# ============================================================================
# STAGE: Lint
# ============================================================================

code-quality:
  stage: lint
  dependencies:
    - install-dependencies
  before_script:
    - apt-get update && apt-get install -y curl
    - curl -sSL https://install.python-poetry.org | python3 -
    - export PATH="/root/.local/bin:$PATH"
  script:
    - cd backend
    - echo "Running code quality checks..."
    - |
      if poetry run which ruff > /dev/null 2>&1; then
        poetry run ruff check app/
      else
        echo "Ruff not installed, skipping..."
      fi
    - |
      if poetry run which black > /dev/null 2>&1; then
        poetry run black --check app/
      else
        echo "Black not installed, skipping..."
      fi
  allow_failure: true

# ============================================================================
# STAGE: Test - Security
# ============================================================================

security-tests:
  stage: security
  dependencies:
    - install-dependencies
  services:
    - postgres:15-alpine
    - redis:7-alpine
  before_script:
    - apt-get update && apt-get install -y curl postgresql-client
    - curl -sSL https://install.python-poetry.org | python3 -
    - export PATH="/root/.local/bin:$PATH"
  script:
    - cd backend
    - echo "Waiting for PostgreSQL..."
    - until pg_isready -h postgres -p 5432 -U $POSTGRES_USER; do sleep 1; done
    - echo "Running security tests..."
    - poetry run pytest tests/security/ -v --tb=short --junitxml=report-security.xml
  artifacts:
    when: always
    reports:
      junit: backend/report-security.xml
    paths:
      - backend/report-security.xml
    expire_in: 1 week

security-audit:
  stage: security
  dependencies:
    - install-dependencies
  services:
    - postgres:15-alpine
    - redis:7-alpine
  before_script:
    - apt-get update && apt-get install -y curl postgresql-client
    - curl -sSL https://install.python-poetry.org | python3 -
    - export PATH="/root/.local/bin:$PATH"
  script:
    - cd backend
    - echo "Waiting for PostgreSQL..."
    - until pg_isready -h postgres -p 5432 -U $POSTGRES_USER; do sleep 1; done
    - echo "Running security audit..."
    - poetry run pytest tests/security/test_security_audit.py -v -s --junitxml=report-audit.xml
  artifacts:
    when: always
    reports:
      junit: backend/report-audit.xml
    paths:
      - backend/report-audit.xml
    expire_in: 1 week

# ============================================================================
# STAGE: Test - Performance
# ============================================================================

performance-tests:
  stage: test
  dependencies:
    - install-dependencies
  services:
    - postgres:15-alpine
  before_script:
    - apt-get update && apt-get install -y curl postgresql-client
    - curl -sSL https://install.python-poetry.org | python3 -
    - export PATH="/root/.local/bin:$PATH"
  script:
    - cd backend
    - echo "Waiting for PostgreSQL..."
    - until pg_isready -h postgres -p 5432 -U $POSTGRES_USER; do sleep 1; done
    - echo "Running performance tests..."
    - poetry run pytest tests/performance/ -v --tb=short --junitxml=report-performance.xml
  artifacts:
    when: always
    reports:
      junit: backend/report-performance.xml
    paths:
      - backend/report-performance.xml
    expire_in: 1 week

# ============================================================================
# STAGE: Test - Unit & Integration
# ============================================================================

unit-tests:
  stage: test
  dependencies:
    - install-dependencies
  services:
    - name: postgres:15-alpine
      alias: postgres
    - name: redis:7-alpine
      alias: redis
    - name: minio/minio:latest
      alias: minio
      command: ["server", "/data"]
      variables:
        MINIO_ROOT_USER: test_minio_access_key_12_chars
        MINIO_ROOT_PASSWORD: test_minio_secret_key_12_chars
  before_script:
    - apt-get update && apt-get install -y curl postgresql-client
    - curl -sSL https://install.python-poetry.org | python3 -
    - export PATH="/root/.local/bin:$PATH"
  script:
    - cd backend
    - echo "Waiting for services..."
    - until pg_isready -h postgres -p 5432 -U $POSTGRES_USER; do sleep 1; done
    - echo "Running database migrations..."
    - poetry run alembic upgrade head
    - echo "Running all tests with coverage..."
    - poetry run pytest tests/ -v --cov=app --cov-report=xml --cov-report=html --cov-report=term --junitxml=report-unit.xml
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    when: always
    reports:
      junit: backend/report-unit.xml
      coverage_report:
        coverage_format: cobertura
        path: backend/coverage.xml
    paths:
      - backend/htmlcov/
      - backend/coverage.xml
      - backend/report-unit.xml
    expire_in: 1 week

# ============================================================================
# STAGE: Build - Docker Image
# ============================================================================

build-docker-image:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_DRIVER: overlay2
  before_script:
    - docker info
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - cd backend
    - |
      # Build Docker image with metadata
      docker build \
        --build-arg VERSION=${CI_COMMIT_SHA} \
        --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
        --build-arg VCS_REF=${CI_COMMIT_SHA} \
        --tag ${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_REF_SLUG} \
        --tag ${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_SHORT_SHA} \
        --file Dockerfile \
        .
    - docker push ${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_REF_SLUG}
    - docker push ${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_SHORT_SHA}
    - |
      # Tag as latest if on main branch
      if [ "$CI_COMMIT_REF_NAME" == "main" ]; then
        docker tag ${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_REF_SLUG} ${CI_REGISTRY_IMAGE}/backend:latest
        docker push ${CI_REGISTRY_IMAGE}/backend:latest
      fi
  only:
    - main
    - develop
    - /^claude\/.*$/
  dependencies: []

# ============================================================================
# STAGE: Deploy (Example - adjust for your infrastructure)
# ============================================================================

deploy-staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $STAGING_SERVER >> ~/.ssh/known_hosts
  script:
    - echo "Deploying to staging environment..."
    - |
      ssh $STAGING_USER@$STAGING_SERVER << 'EOF'
        cd /opt/wanllmdb
        docker-compose -f docker-compose.prod.yml pull backend
        docker-compose -f docker-compose.prod.yml up -d backend
        docker-compose -f docker-compose.prod.yml exec -T backend alembic upgrade head
      EOF
    - echo "✅ Staging deployment complete"
  environment:
    name: staging
    url: https://staging.wanllmdb.example.com
  only:
    - develop
  when: manual
  needs:
    - build-docker-image

deploy-production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $PRODUCTION_SERVER >> ~/.ssh/known_hosts
  script:
    - echo "Deploying to production environment..."
    - |
      ssh $PRODUCTION_USER@$PRODUCTION_SERVER << 'EOF'
        cd /opt/wanllmdb
        docker-compose -f docker-compose.prod.yml pull backend
        docker-compose -f docker-compose.prod.yml up -d backend
        docker-compose -f docker-compose.prod.yml exec -T backend alembic upgrade head
      EOF
    - echo "✅ Production deployment complete"
  environment:
    name: production
    url: https://wanllmdb.example.com
  only:
    - main
  when: manual
  needs:
    - build-docker-image

# ============================================================================
# Test Summary Job
# ============================================================================

test-summary:
  stage: .post
  image: alpine:latest
  script:
    - echo "======================================"
    - echo "wanLLMDB GitLab CI/CD Summary"
    - echo "======================================"
    - echo "Pipeline ID: $CI_PIPELINE_ID"
    - echo "Commit: $CI_COMMIT_SHORT_SHA"
    - echo "Branch: $CI_COMMIT_REF_NAME"
    - echo "Author: $CI_COMMIT_AUTHOR"
    - echo ""
    - echo "All test stages completed successfully!"
    - echo "======================================"
  when: on_success
  dependencies: []
